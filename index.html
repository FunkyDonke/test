<!DOCTYPE html>
<html lang="bn" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>স্মার্ট পাঠশালা - আলটিমেট</title>
    <!-- Tailwind CSS with Typography Plugin -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Hind Siliguri', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { font-family: 'Hind Siliguri', sans-serif; overflow-x: hidden; }
        .gradient-text {
            background: linear-gradient(to right, #4f46e5, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        .dark ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow: hidden; }
        
        /* Drag & Nesting Styles */
        .btn-visible-anim { display: flex !important; animation: popIn 0.2s ease-out; }
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 80% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        .dragging { opacity: 0.5; border: 2px dashed #4f46e5; }
        .drag-over { background-color: rgba(79, 70, 229, 0.1); border: 2px dashed #4f46e5; }
        .drag-over-top { border-top: 3px solid #10b981; }
        .drag-over-bottom { border-bottom: 3px solid #10b981; }
        .drag-over-middle { background-color: rgba(79, 70, 229, 0.15); border: 2px dashed #4f46e5; border-radius: 0.5rem; }
        .is-hidden-subject { opacity: 0.6; border: 2px dashed #9ca3af; filter: grayscale(100%); transition: all 0.3s ease; }

        /* Accordion */
        .accordion-content { transition: max-height 0.3s ease-out, opacity 0.3s ease-out; max-height: 0; overflow: hidden; opacity: 0; margin-left: 0.75rem; border-left: 1px solid #e5e7eb; }
        .dark .accordion-content { border-left-color: #374151; }
        .accordion-content.open { max-height: 10000px; opacity: 1; }

        /* Custom Checkbox */
        .custom-checkbox { width: 1.25rem; height: 1.25rem; cursor: pointer; border-radius: 0.25rem; accent-color: #4f46e5; }
        
        /* Tab Active State */
        .tab-active { border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: 600; }
        .dark .tab-active { border-bottom: 2px solid #818cf8; color: #818cf8; }

        /* Resizable Video Card */
        .resizable-card {
            resize: both;
            overflow: hidden;
            min-width: 320px;
            min-height: 240px;
            max-width: 100%;
            display: flex;
            flex-direction: column;
            background-color: black;
        }
        
        /* Group Optional Style */
        .group-optional { background-image: linear-gradient(45deg, rgba(79, 70, 229, 0.05) 25%, transparent 25%, transparent 50%, rgba(79, 70, 229, 0.05) 50%, rgba(79, 70, 229, 0.05) 75%, transparent 75%, transparent); background-size: 20px 20px; border: 2px dashed #6366f1; }
        .dark .group-optional { background-image: linear-gradient(45deg, rgba(255, 255, 255, 0.03) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.03) 50%, rgba(255, 255, 255, 0.03) 75%, transparent 75%, transparent); border-color: #818cf8; }
        
        /* Markdown Specific Styles */
        .prose img { margin: 1rem auto; border-radius: 0.5rem; }
        .prose a { color: #4f46e5; text-decoration: none; }
        .prose a:hover { text-decoration: underline; }
        .prose table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
        .prose th, .prose td { border: 1px solid #e5e7eb; padding: 0.5rem; text-align: left; }
        .dark .prose th, .dark .prose td { border-color: #374151; }
        .prose th { background-color: #f9fafb; font-weight: 600; }
        .dark .prose th { background-color: #1f2937; }
        .prose blockquote { border-left: 4px solid #e5e7eb; padding-left: 1rem; color: #6b7280; font-style: italic; }
        .dark .prose blockquote { border-color: #374151; color: #9ca3af; }
    </style>
</head>
<body class="h-screen flex flex-col text-gray-800 bg-gray-50 dark:bg-gray-950 dark:text-gray-100 transition-colors duration-300">

    <!-- Navbar -->
    <nav class="bg-white/90 dark:bg-gray-900/90 backdrop-blur-md z-50 shadow-sm border-b border-gray-100 dark:border-gray-800 flex-none sticky top-0">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center cursor-pointer gap-2" onclick="goHome()">
                    <i data-lucide="book-open" class="h-8 w-8 text-indigo-600"></i>
                    <span class="text-2xl font-bold text-gray-900 dark:text-white">স্মার্ট<span class="text-indigo-600 dark:text-indigo-400">পাঠশালা</span></span>
                </div>
                <div class="flex items-center gap-2 md:gap-4">
                    <div class="hidden md:flex gap-2">
                         <button onclick="confirmReset()" class="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 px-3 py-2 rounded-lg text-sm font-medium transition flex items-center gap-1">
                            <i data-lucide="rotate-ccw" class="h-4 w-4"></i> রিসেট
                        </button>
                        <button onclick="exportData()" class="text-indigo-600 dark:text-indigo-400 hover:bg-indigo-50 dark:hover:bg-gray-800 px-3 py-2 rounded-lg text-sm font-medium transition flex items-center gap-1">
                            <i data-lucide="database" class="h-4 w-4"></i> ব্যাকআপ
                        </button>
                    </div>
                    <button onclick="toggleTheme()" class="p-2 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 transition">
                        <i data-lucide="moon" id="theme-icon" class="h-5 w-5"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="main-container" class="flex-grow w-full overflow-hidden relative">
        <div class="h-full w-full overflow-y-auto px-4 custom-scrollbar"> 
            <div class="max-w-7xl mx-auto h-full flex flex-col">
            
                <!-- VIEW 1: Class Selection -->
                <div id="view-classes" class="fade-in py-10 flex-grow flex flex-col justify-center">
                    <div class="text-center mb-10">
                        <h1 class="text-4xl md:text-6xl font-bold mb-4 text-gray-900 dark:text-white">আপনার <span class="gradient-text">শ্রেণী</span> নির্বাচন করুন</h1>
                        <p class="text-lg text-gray-600 dark:text-gray-400">ডিজিটাল পাঠ্যবই এবং নোট ম্যানেজমেন্ট সিস্টেম</p>
                    </div>
                    <div id="row-junior" class="flex flex-wrap justify-center gap-6 mb-8"></div>
                    <div id="row-senior" class="flex flex-wrap justify-center gap-6"></div>
                </div>

                <!-- VIEW 2: Subject Selection -->
                <div id="view-subjects" class="hidden fade-in pb-20 relative">
                     <!-- Bulk Action Bar -->
                    <div id="bulk-action-bar-subjects" class="hidden fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50 bg-white dark:bg-gray-800 shadow-xl border border-gray-200 dark:border-gray-700 rounded-full px-6 py-3 flex items-center gap-4 animate-bounce-in">
                        <span class="text-sm font-bold text-gray-700 dark:text-white"><span id="selected-count-subs">0</span> টি নির্বাচিত</span>
                        <div class="h-4 w-px bg-gray-300 dark:bg-gray-600"></div>
                        <button onclick="bulkToggleVisibilitySubjects()" class="text-gray-600 dark:text-gray-300 hover:text-indigo-600 dark:hover:text-indigo-400 transition" title="হাইড/শো (ঐচ্ছিক)"><i data-lucide="eye" class="h-5 w-5"></i></button>
                        <button onclick="bulkDeleteSubjects()" class="text-red-500 hover:text-red-700 transition" title="ডিলিট"><i data-lucide="trash-2" class="h-5 w-5"></i></button>
                        <button onclick="clearSelection()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition"><i data-lucide="x" class="h-5 w-5"></i></button>
                    </div>

                    <!-- Sticky Header -->
                    <div class="sticky top-0 z-30 bg-gray-50/95 dark:bg-gray-950/95 pt-4 pb-4 mb-4 border-b border-gray-200 dark:border-gray-800 shadow-sm transition-colors backdrop-blur-md">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div class="flex items-center gap-3">
                                <button onclick="goHome()" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 transition">
                                    <i data-lucide="arrow-left" class="h-6 w-6"></i>
                                </button>
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white"><span id="selected-class-name" class="text-indigo-600 dark:text-indigo-400"></span></h2>
                                    <p class="text-xs text-gray-500">বিষয় নির্বাচন করুন</p>
                                </div>
                            </div>
                            <div class="flex flex-wrap items-center gap-3 w-full md:w-auto">
                                <div id="group-selector-container" class="hidden">
                                    <select id="group-select" onchange="updateGroup()" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                                        <option value="science">বিজ্ঞান (Science)</option>
                                        <option value="arts">মানবিক (Arts)</option>
                                        <option value="commerce">ব্যবসায় শিক্ষা (Commerce)</option>
                                    </select>
                                </div>
                                <div class="flex items-center gap-2 ml-auto">
                                    <label class="flex items-center cursor-pointer select-none bg-white dark:bg-gray-800 px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700">
                                        <span class="text-xs font-medium mr-2">ঐচ্ছিক বিষয়</span>
                                        <input type="checkbox" id="toggle-optional" class="accent-indigo-600 w-4 h-4" onchange="toggleOptionalSubjects()">
                                    </label>
                                    <button id="btn-edit-mode" onclick="toggleEditMode()" class="flex items-center gap-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-3 py-2 rounded-lg text-sm font-medium transition">
                                        <i data-lucide="edit-3" class="h-4 w-4"></i> এডিট
                                    </button>
                                    <div class="relative group">
                                         <button class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                                            <i data-lucide="plus" class="h-4 w-4"></i> যুক্ত করুন
                                        </button>
                                        <div class="absolute right-0 mt-2 w-56 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-100 dark:border-gray-700 hidden group-hover:block z-50 overflow-hidden">
                                            <button onclick="openAddSubjectModal()" class="w-full text-left px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 text-sm flex items-center gap-2"><i data-lucide="plus-circle" class="h-4 w-4"></i> ম্যানুয়াল যোগ</button>
                                            <button onclick="openBulkImportSubjectModal()" class="w-full text-left px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 text-sm border-t border-gray-100 dark:border-gray-700 flex items-center gap-2"><i data-lucide="list-plus" class="h-4 w-4"></i> বাল্ক ইম্পোর্ট</button>
                                            <button onclick="exportClassData()" class="w-full text-left px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 text-sm border-t border-gray-100 dark:border-gray-700 flex items-center gap-2 text-indigo-600"><i data-lucide="download" class="h-4 w-4"></i> বাল্ক এক্সপোর্ট</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="subject-content" class="min-h-[50vh]"></div>
                </div>

                <!-- VIEW 3: Reader View -->
                <div id="view-reader" class="hidden fade-in h-full flex flex-col relative pt-4">
                     <!-- Bulk Action Bar -->
                    <div id="bulk-action-bar-chapters" class="hidden absolute bottom-6 left-1/2 transform -translate-x-1/2 z-50 bg-white dark:bg-gray-800 shadow-xl border border-gray-200 dark:border-gray-700 rounded-full px-6 py-3 flex items-center gap-4 animate-bounce-in">
                        <span class="text-sm font-bold text-gray-700 dark:text-white"><span id="selected-count-chaps">0</span> টি নির্বাচিত</span>
                         <div class="h-4 w-px bg-gray-300 dark:bg-gray-600"></div>
                        <button onclick="bulkDeleteChapters()" class="text-red-500 hover:text-red-700 transition" title="ডিলিট"><i data-lucide="trash-2" class="h-5 w-5"></i></button>
                        <button onclick="clearSelection()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition"><i data-lucide="x" class="h-5 w-5"></i></button>
                    </div>

                    <div class="flex flex-col lg:flex-row gap-6 h-full pb-2 overflow-hidden">
                        <!-- Sidebar (Table of Contents) -->
                        <div class="w-full lg:w-80 flex-none flex flex-col h-[30vh] lg:h-full bg-white dark:bg-gray-900 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-800 overflow-hidden">
                            <div class="p-4 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center bg-gray-50 dark:bg-gray-800/50">
                                <button onclick="showSubjects()" class="text-gray-500 hover:text-indigo-600 transition"><i data-lucide="arrow-left" class="h-5 w-5"></i></button>
                                <span class="font-bold text-gray-700 dark:text-gray-200 truncate mx-2">সূচিপত্র</span>
                                <div class="flex gap-1 flex-shrink-0">
                                    <button onclick="exportChapterData()" title="Export List" class="p-1.5 text-indigo-600 hover:bg-indigo-50 rounded"><i data-lucide="download" class="h-4 w-4"></i></button>
                                    <button onclick="openBulkImportSubjectModal(true)" title="Import List" class="p-1.5 text-indigo-600 hover:bg-indigo-50 rounded"><i data-lucide="file-text" class="h-4 w-4"></i></button>
                                    <button id="btn-edit-mode-reader" onclick="toggleEditMode()" title="Edit" class="p-1.5 text-gray-600 hover:bg-gray-200 rounded"><i data-lucide="edit-3" class="h-4 w-4"></i></button>
                                    <button onclick="openAddChapterModal()" title="Add" class="p-1.5 text-green-600 hover:bg-green-50 rounded"><i data-lucide="plus" class="h-4 w-4"></i></button>
                                </div>
                            </div>
                            <div id="chapter-list" class="flex-grow overflow-y-auto p-2 custom-scrollbar"></div>
                            <div id="empty-chapters-msg" class="hidden p-8 text-center text-sm text-gray-400">কোন অধ্যায় নেই।</div>
                        </div>

                        <!-- Content Area (Reader Features) -->
                        <div class="flex-grow h-full bg-white dark:bg-gray-900 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-800 overflow-hidden flex flex-col relative">
                            <!-- Content Header with Tabs -->
                            <div class="flex-none border-b border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-gray-800/50">
                                <div class="p-6 pb-2">
                                    <h1 id="chapter-title" class="text-xl md:text-2xl font-bold text-gray-900 dark:text-white">স্বাগতম</h1>
                                    <p id="reader-subject-title" class="text-sm text-gray-500 mt-1">বিষয় নির্বাচন করুন</p>
                                </div>
                                
                                <!-- Tabs -->
                                <div id="content-tabs" class="flex px-6 gap-6 overflow-x-auto hidden">
                                    <button onclick="switchTab('text')" class="tab-btn pb-3 text-sm font-medium text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 flex items-center gap-2 whitespace-nowrap" id="tab-btn-text">
                                        <i data-lucide="file-text" class="h-4 w-4"></i> ডিজিটাল পাঠ (Docs/MD)
                                    </button>
                                    <button onclick="switchTab('pdf')" class="tab-btn pb-3 text-sm font-medium text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 flex items-center gap-2 whitespace-nowrap" id="tab-btn-pdf">
                                        <i data-lucide="file" class="h-4 w-4"></i> মূল বই (PDF)
                                    </button>
                                    <button onclick="switchTab('video')" class="tab-btn pb-3 text-sm font-medium text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 flex items-center gap-2 whitespace-nowrap" id="tab-btn-video">
                                        <i data-lucide="youtube" class="h-4 w-4"></i> টিউটোরিয়াল
                                    </button>
                                    <button onclick="switchTab('qna')" class="tab-btn pb-3 text-sm font-medium text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 flex items-center gap-2 whitespace-nowrap" id="tab-btn-qna">
                                        <i data-lucide="help-circle" class="h-4 w-4"></i> প্রশ্ন ও উত্তর
                                    </button>
                                </div>
                            </div>

                            <!-- Content Body -->
                            <div id="content-body" class="flex-grow overflow-y-auto p-0 relative bg-white dark:bg-gray-900 custom-scrollbar">
                                
                                <!-- Empty State -->
                                <div id="content-empty" class="flex flex-col items-center justify-center h-full text-gray-400 p-8 text-center">
                                    <i data-lucide="book-open" class="h-16 w-16 mb-4 opacity-20"></i>
                                    <p>বাম পাশের তালিকা থেকে একটি অধ্যায় নির্বাচন করুন।</p>
                                </div>

                                <!-- Tab: Text (Digital) -->
                                <div id="tab-content-text" class="hidden h-full flex flex-col">
                                    <div class="p-4 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center bg-gray-50 dark:bg-gray-800/30">
                                        <div class="flex items-center gap-2">
                                            <span class="text-xs text-gray-500 font-mono">FORMAT: MARKDOWN / RICH TEXT</span>
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="openAddTextLinkModal()" class="text-purple-600 hover:bg-purple-50 dark:hover:bg-gray-700 px-3 py-1.5 rounded-lg text-sm flex items-center gap-1 transition">
                                                <i data-lucide="cloud" class="h-3.5 w-3.5"></i> ক্লাউড লিংক
                                            </button>
                                            <label class="cursor-pointer text-indigo-600 hover:bg-indigo-50 dark:hover:bg-gray-700 px-3 py-1.5 rounded-lg text-sm flex items-center gap-1 transition">
                                                <i data-lucide="upload" class="h-3.5 w-3.5"></i> ফাইল ওপেন (Local)
                                                <input type="file" class="hidden" accept=".txt,.md" onchange="loadLocalTextFile(this)">
                                            </label>
                                            <button onclick="openEditContentModal('text')" class="text-indigo-600 hover:bg-indigo-50 dark:hover:bg-gray-700 px-3 py-1.5 rounded-lg text-sm flex items-center gap-1 transition">
                                                <i data-lucide="edit" class="h-3.5 w-3.5"></i> এডিট
                                            </button>
                                        </div>
                                    </div>
                                    <div id="loading-indicator" class="hidden flex justify-center items-center py-10">
                                        <i data-lucide="loader-2" class="animate-spin h-8 w-8 text-indigo-600"></i>
                                    </div>
                                    <div id="render-markdown" class="prose dark:prose-invert max-w-none p-6 md:p-10"></div>
                                    <div id="empty-text-msg" class="hidden flex-grow flex flex-col items-center justify-center text-gray-400">
                                        <i data-lucide="file-text" class="h-10 w-10 mb-2 opacity-30"></i>
                                        <p>কোন টেক্সট নেই</p>
                                    </div>
                                </div>

                                <!-- Tab: PDF -->
                                <div id="tab-content-pdf" class="hidden h-full flex flex-col">
                                    <div class="p-4 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center bg-gray-50 dark:bg-gray-800/30">
                                        <span class="text-xs text-gray-500">Google Drive বা সরাসরি PDF লিংক সাপোর্ট করে</span>
                                        <div class="flex gap-2">
                                            <label class="cursor-pointer text-indigo-600 hover:bg-indigo-50 dark:hover:bg-gray-700 px-3 py-1.5 rounded-lg text-sm flex items-center gap-1 transition">
                                                <i data-lucide="folder-open" class="h-3.5 w-3.5"></i> লোকাল ফাইল
                                                <input type="file" class="hidden" accept="application/pdf" onchange="loadLocalPdfFile(this)">
                                            </label>
                                            <button onclick="openEditContentModal('pdf')" class="text-indigo-600 hover:bg-indigo-50 dark:hover:bg-gray-700 px-3 py-1.5 rounded-lg text-sm flex items-center gap-1 transition">
                                                <i data-lucide="link" class="h-3.5 w-3.5"></i> লিংক যুক্ত করুন
                                            </button>
                                        </div>
                                    </div>
                                    <iframe id="pdf-frame" class="w-full flex-grow border-none" src=""></iframe>
                                    <div id="empty-pdf-msg" class="hidden flex-grow flex flex-col items-center justify-center text-gray-400">
                                        <i data-lucide="file-question" class="h-10 w-10 mb-2 opacity-30"></i>
                                        <p>কোন PDF লিংক যুক্ত করা হয়নি</p>
                                    </div>
                                </div>

                                <!-- Tab: Video -->
                                <div id="tab-content-video" class="hidden h-full flex flex-col">
                                    <div class="p-4 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center bg-gray-50 dark:bg-gray-800/30">
                                        <span class="text-xs text-gray-500">ভিডিও টিউটোরিয়াল (YouTube / Cloud / Local)</span>
                                        <div class="flex gap-2">
                                            <label class="cursor-pointer text-green-600 hover:bg-green-50 dark:hover:bg-gray-700 px-3 py-1.5 rounded-lg text-sm flex items-center gap-1 transition">
                                                <i data-lucide="film" class="h-3.5 w-3.5"></i> লোকাল ভিডিও
                                                <input type="file" class="hidden" accept="video/*" onchange="loadLocalVideoFile(this)">
                                            </label>
                                            <button onclick="openEditContentModal('video')" class="text-indigo-600 hover:bg-indigo-50 dark:hover:bg-gray-700 px-3 py-1.5 rounded-lg text-sm flex items-center gap-1 transition">
                                                <i data-lucide="plus-circle" class="h-3.5 w-3.5"></i> ভিডিও লিংক
                                            </button>
                                        </div>
                                    </div>
                                    <div id="video-grid" class="p-6 flex flex-wrap gap-6 items-start content-start"></div>
                                    <div id="empty-video-msg" class="hidden flex-grow flex flex-col items-center justify-center text-gray-400 py-20">
                                        <i data-lucide="video-off" class="h-10 w-10 mb-2 opacity-30"></i>
                                        <p>কোন ভিডিও টিউটোরিয়াল নেই</p>
                                    </div>
                                </div>

                                <!-- Tab: Q&A -->
                                <div id="tab-content-qna" class="hidden h-full flex flex-col">
                                     <div class="p-4 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center bg-gray-50 dark:bg-gray-800/30">
                                        <span class="text-xs text-gray-500">গুরুত্বপূর্ণ প্রশ্ন ও উত্তর</span>
                                        <button onclick="openEditContentModal('qna')" class="text-indigo-600 hover:bg-indigo-50 dark:hover:bg-gray-700 px-3 py-1.5 rounded-lg text-sm flex items-center gap-1 transition">
                                            <i data-lucide="plus-circle" class="h-3.5 w-3.5"></i> প্রশ্ন / লিংক যুক্ত করুন
                                        </button>
                                    </div>
                                    <div id="qna-list" class="p-6 space-y-4"></div>
                                    <div id="empty-qna-msg" class="hidden flex-grow flex flex-col items-center justify-center text-gray-400 py-20">
                                        <i data-lucide="help-circle" class="h-10 w-10 mb-2 opacity-30"></i>
                                        <p>কোন প্রশ্ন যুক্ত করা হয়নি</p>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- MODALS -->
    
    <!-- Add Text Link Modal -->
    <div id="modal-add-text-link" class="modal opacity-0 pointer-events-none fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 w-11/12 max-w-md rounded-xl shadow-2xl p-6">
            <h3 class="text-xl font-bold dark:text-white mb-4">ক্লাউড টেক্সট লিংক</h3>
            <input type="text" id="input-text-url" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white outline-none mb-2" placeholder="Google Drive / Raw Text URL">
            <p class="text-xs text-gray-500 mb-4">Google Drive এর লিংকটি 'Anyone with the link' মুডে থাকতে হবে।</p>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('modal-add-text-link')" class="px-4 py-2 text-gray-500">বাতিল</button>
                <button onclick="saveTextLink()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">সংরক্ষণ</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="modal-confirm" class="modal opacity-0 pointer-events-none fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 w-11/12 max-w-sm rounded-xl shadow-2xl overflow-hidden transform scale-95 transition-all">
            <div class="p-6 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900/30 mb-4">
                    <i data-lucide="alert-triangle" class="h-6 w-6 text-red-600"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-900 dark:text-white">সতর্কীকরণ</h3>
                <p id="confirm-modal-text" class="text-sm text-gray-500 mt-2">আপনি কি নিশ্চিত?</p>
            </div>
            <div class="bg-gray-50 dark:bg-gray-800/50 px-6 py-4 flex gap-3">
                <button onclick="closeModal('modal-confirm')" class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-700">বাতিল</button>
                <button id="confirm-modal-btn" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700">নিশ্চিত</button>
            </div>
        </div>
    </div>

    <!-- Subject Modal -->
    <div id="modal-subject" class="modal opacity-0 pointer-events-none fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 w-11/12 max-w-md rounded-xl shadow-2xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-subject-title" class="text-xl font-bold dark:text-white">নতুন বিষয়</h3>
                <button onclick="closeModal('modal-subject')"><i data-lucide="x" class="text-gray-500"></i></button>
            </div>
            <div class="space-y-4">
                <input type="hidden" id="input-sub-id">
                <input type="text" id="input-sub-name" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white outline-none" placeholder="নাম">
                <input type="text" id="input-sub-desc" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white outline-none" placeholder="বিবরণ (অপশনাল)">
                <div id="modal-group-select-wrapper" class="hidden">
                    <select id="input-sub-group" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white">
                        <option value="common">আবশ্যিক (Common)</option><option value="science">বিজ্ঞান</option><option value="arts">মানবিক</option><option value="commerce">ব্যবসায় শিক্ষা</option>
                    </select>
                </div>
                <label class="flex items-center gap-2"><input type="checkbox" id="input-sub-optional" class="rounded text-indigo-600"><span class="text-sm text-gray-700 dark:text-gray-300">ঐচ্ছিক বিষয়?</span></label>
                <div class="flex justify-end gap-2 mt-6">
                    <button onclick="closeModal('modal-subject')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">বাতিল</button>
                    <button onclick="saveSubject()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">সংরক্ষণ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Import Modal -->
    <div id="modal-bulk-import" class="modal opacity-0 pointer-events-none fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 w-11/12 max-w-lg rounded-xl shadow-2xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-bulk-title" class="text-xl font-bold dark:text-white">বাল্ক ইম্পোর্ট</h3>
                <button onclick="closeModal('modal-bulk-import')"><i data-lucide="x" class="text-gray-500"></i></button>
            </div>
            <div id="bulk-import-controls" class="flex items-center gap-2 mb-3 bg-indigo-50 dark:bg-gray-800 p-2 rounded-lg">
                <input type="checkbox" id="bulk-include-chapters" class="h-4 w-4">
                <label for="bulk-include-chapters" class="text-sm font-medium dark:text-gray-300">সূচিপত্র সহ (Advanced)</label>
            </div>
            <p id="bulk-import-help" class="text-xs text-gray-500 mb-2">ফরম্যাট: *বিষয়, **অপ্রয়োজনীয়, !1বিজ্ঞান, !1*ঐচ্ছিক</p>
            <textarea id="bulk-import-text" class="w-full h-48 p-3 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white font-mono text-sm outline-none" placeholder="*বাংলা&#10;**সংগীত&#10;!1পদার্থবিজ্ঞান&#10;!1*উচ্চতর গণিত&#10;!12*কৃষিশিক্ষা"></textarea>
            <div class="flex justify-end gap-2 mt-4">
                <button id="btn-bulk-process" onclick="processBulkImport()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">ইম্পোর্ট করুন</button>
            </div>
        </div>
    </div>

    <!-- Add Chapter Modal -->
    <div id="modal-add-chapter" class="modal opacity-0 pointer-events-none fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 w-11/12 max-w-sm rounded-xl shadow-2xl p-6">
            <h3 class="text-xl font-bold dark:text-white mb-4">নতুন অধ্যায়</h3>
            <input type="text" id="input-chap-name" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white outline-none" placeholder="নাম">
            <div class="flex justify-end gap-2 mt-4">
                <button onclick="closeModal('modal-add-chapter')" class="px-4 py-2 text-gray-500">বাতিল</button>
                <button onclick="saveNewChapter()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">সংরক্ষণ</button>
            </div>
        </div>
    </div>

    <!-- CONTENT EDIT MODALS -->

    <!-- Edit Text/Markdown Modal -->
    <div id="modal-edit-text" class="modal opacity-0 pointer-events-none fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 w-11/12 max-w-4xl h-[80vh] rounded-xl shadow-2xl p-6 flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-none">
                <h3 class="text-xl font-bold dark:text-white">ডিজিটাল পাঠ এডিট (Markdown)</h3>
                <button onclick="closeModal('modal-edit-text')"><i data-lucide="x" class="text-gray-500"></i></button>
            </div>
            <div class="flex-grow flex flex-col md:flex-row gap-4 h-full overflow-hidden">
                <textarea id="input-content-text" class="w-full md:w-1/2 h-full p-4 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white font-mono text-sm outline-none resize-none focus:ring-2 focus:ring-indigo-500" placeholder="# শিরোনাম&#10;**বোল্ড টেক্সট**&#10;- তালিকা ১&#10;- তালিকা ২"></textarea>
                <div class="hidden md:block w-1/2 h-full border rounded-lg p-4 overflow-y-auto bg-gray-50 dark:bg-gray-800/50 prose dark:prose-invert" id="preview-content-text">
                    <p class="text-gray-400 text-center mt-10">Preview</p>
                </div>
            </div>
            <div class="flex-none flex justify-end gap-2 mt-4">
                <button onclick="saveContentText()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">সংরক্ষণ করুন</button>
            </div>
        </div>
    </div>

    <!-- Edit PDF Modal -->
    <div id="modal-edit-pdf" class="modal opacity-0 pointer-events-none fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 w-11/12 max-w-md rounded-xl shadow-2xl p-6">
            <h3 class="text-xl font-bold dark:text-white mb-4">PDF লিংক যুক্ত করুন</h3>
            <p class="text-xs text-gray-500 mb-2">Google Drive লিংক দিলে সেটি অটোমেটিক এমবেড লিংকে কনভার্ট হবে।</p>
            <input type="text" id="input-content-pdf" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white outline-none mb-4" placeholder="https://...">
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('modal-edit-pdf')" class="px-4 py-2 text-gray-500">বাতিল</button>
                <button onclick="saveContentPdf()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">সংরক্ষণ</button>
            </div>
        </div>
    </div>

    <!-- Edit Video Modal -->
    <div id="modal-edit-video" class="modal opacity-0 pointer-events-none fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 w-11/12 max-w-md rounded-xl shadow-2xl p-6">
            <h3 class="text-xl font-bold dark:text-white mb-4">নতুন ভিডিও লিংক</h3>
            <input type="text" id="input-video-title" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white outline-none mb-3" placeholder="ভিডিও শিরোনাম">
            <input type="text" id="input-video-url" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white outline-none mb-2" placeholder="Video Link or Embed Code">
            <p class="text-xs text-gray-500 mb-4">ইউটিউব লিংক বা &lt;iframe&gt; এমবেড কোড দিন।</p>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('modal-edit-video')" class="px-4 py-2 text-gray-500">বাতিল</button>
                <button onclick="addVideo()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">যুক্ত করুন</button>
            </div>
            <div id="video-list-manage" class="mt-4 max-h-40 overflow-y-auto border-t pt-2">
                <!-- List of existing videos to delete will go here -->
            </div>
        </div>
    </div>

    <!-- Edit Q&A Modal -->
    <div id="modal-edit-qna" class="modal opacity-0 pointer-events-none fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 w-11/12 max-w-lg rounded-xl shadow-2xl p-6">
            <h3 class="text-xl font-bold dark:text-white mb-4">প্রশ্ন ও উত্তর / লিংক</h3>
            <textarea id="input-qna-q" class="w-full p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white outline-none mb-2 font-bold" rows="2" placeholder="প্রশ্ন বা শিরোনাম..."></textarea>
            <textarea id="input-qna-a" class="w-full p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white outline-none mb-4" rows="4" placeholder="উত্তর বা লিংক..."></textarea>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('modal-edit-qna')" class="px-4 py-2 text-gray-500">বাতিল</button>
                <button onclick="addQna()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">যুক্ত করুন</button>
            </div>
             <div id="qna-list-manage" class="mt-4 max-h-40 overflow-y-auto border-t pt-2 space-y-2">
                <!-- Manage existing QnA -->
            </div>
        </div>
    </div>


    <script>
        // --- DATA & INITIALIZATION ---
        const defaultClass6Data = [
            { name: 'বাংলা', icon: 'book-open', chapters: ['১. সততার পুরস্কার', '২. মিনু'] },
            { name: 'English', icon: 'languages', chapters: ['Lesson 1: Going to a New School'] },
            { name: 'গণিত', icon: 'calculator', chapters: ['১. স্বাভাবিক সংখ্যা', '২. অনুপাত'] },
            { name: 'বিজ্ঞান', icon: 'flask-conical', chapters: ['১. বৈজ্ঞানিক প্রক্রিয়া'] },
        ];

        let subjectsData = {};
        let currentClass = null;
        let currentSubject = null;
        let currentChapterNode = null; 
        let activeTab = 'text'; 

        let currentGroup = 'science';
        let showOptional = false;
        let isEditMode = false;
        let dragSrcId = null;
        let expandTimer = null;
        let openAccordionIds = new Set();
        let selectedIds = new Set();
        let saveDataTimeout = null; // Debounce for saving size

        function init() {
            // Check for previous data
            const stored = localStorage.getItem('smartPathshalaData_v2') || localStorage.getItem('smartPathshalaData');
            if (stored) {
                subjectsData = JSON.parse(stored);
            } else {
                [6,7,8,9,11].forEach(c => subjectsData[c] = []);
                subjectsData[6] = defaultClass6Data.map((s, i) => ({
                    id: `sub_6_${Date.now()}_${i}`,
                    name: s.name,
                    icon: s.icon,
                    desc: 'পাঠ্যবই',
                    isOptional: false,
                    group: 'common',
                    chapters: normalizeChapters(s.chapters)
                }));
                saveData();
            }
            renderClassCards();
            checkTheme();
            lucide.createIcons();
            
            // Load YouTube API
            var tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            var firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

            document.getElementById('input-content-text').addEventListener('input', function() {
                document.getElementById('preview-content-text').innerHTML = marked.parse(this.value);
            });
            
             // Custom Renderer
            const renderer = new marked.Renderer();
            
            // Image Renderer
            renderer.image = function(href, title, text) {
                return `<img src="${href}" alt="${text}" title="${title || ''}" class="max-w-full h-auto rounded-lg shadow-md my-4 mx-auto block" onerror="this.style.display='none'; this.insertAdjacentHTML('afterend', '<p class=\\'text-red-400 text-xs italic text-center\\'>[ইমেজ লোড ব্যর্থ: সঠিক URL দিন]</p>')">`;
            };

            // Link Renderer
            renderer.link = function(href, title, text) {
                return `<a href="${href}" title="${title || ''}" target="_blank" class="text-blue-600 hover:underline break-words">${text}</a>`;
            };
            
            // Table Renderer
            renderer.table = function(header, body) {
                return `<div class="overflow-x-auto my-4 rounded-lg border border-gray-200 dark:border-gray-700">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-800">${header}</thead>
                                <tbody class="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700">${body}</tbody>
                            </table>
                        </div>`;
            };

            marked.setOptions({
                renderer: renderer,
                gfm: true,
                breaks: true
            });

            // Debounced Save Helper
            window.debouncedSave = function() {
                if(saveDataTimeout) clearTimeout(saveDataTimeout);
                saveDataTimeout = setTimeout(() => {
                    saveData();
                    console.log('Saved data (debounced)');
                }, 1000);
            };
        }

        function normalizeChapters(list) {
            if(!list) return [];
            return list.map(item => {
                const title = typeof item === 'string' ? item : item.title;
                const node = {
                    id: item.id || `ch_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
                    title: title,
                    children: typeof item === 'object' && item.children ? normalizeChapters(item.children) : [],
                    content: (typeof item === 'object' && item.content) ? item.content : { text: '', pdfUrl: '', videos: [], qna: [], textUrl: '' }
                };
                return node;
            });
        }
        
        function ensureContentStructure(node) {
            if(!node.content) node.content = { text: '', pdfUrl: '', videos: [], qna: [], textUrl: '' };
            if(!node.content.textUrl) node.content.textUrl = ''; 
            if(node.children) node.children.forEach(ensureContentStructure);
        }

        function saveData() { localStorage.setItem('smartPathshalaData_v2', JSON.stringify(subjectsData)); }
        function resetData() { localStorage.removeItem('smartPathshalaData_v2'); localStorage.removeItem('smartPathshalaData'); location.reload(); }

        // --- NAVIGATION & UI ---
        function hideAllViews() { 
            ['view-classes', 'view-subjects', 'view-reader'].forEach(id => document.getElementById(id).classList.add('hidden')); 
        }
        function goHome() {
            hideAllViews(); document.getElementById('view-classes').classList.remove('hidden');
            currentClass = null; isEditMode = false; selectedIds.clear(); updateEditModeUI();
        }
        function selectClass(clsId, clsName) {
            currentClass = { id: clsId, name: clsName };
            hideAllViews(); document.getElementById('view-subjects').classList.remove('hidden');
            document.getElementById('selected-class-name').innerText = clsName;
            const gs = document.getElementById('group-selector-container');
            if(clsId===9||clsId===11) gs.classList.remove('hidden'); else gs.classList.add('hidden');
            isEditMode=false; selectedIds.clear(); updateEditModeUI(); renderSubjects();
        }
        function showSubjects() {
             if(currentClass) {
                 hideAllViews(); document.getElementById('view-subjects').classList.remove('hidden');
                 isEditMode=false; selectedIds.clear(); updateEditModeUI(); renderSubjects();
             }
        }

        // --- CLASS & SUBJECT RENDER ---
        function renderClassCards() {
            const rowJun = document.getElementById('row-junior'); const rowSen = document.getElementById('row-senior');
            const classes = [
                { id: 6, name: 'ষষ্ঠ শ্রেণী', icon: 'graduation-cap', color: 'text-blue-600 bg-blue-50 dark:bg-blue-900/20' },
                { id: 7, name: 'সপ্তম শ্রেণী', icon: 'book-open', color: 'text-green-600 bg-green-50 dark:bg-green-900/20' },
                { id: 8, name: 'অষ্টম শ্রেণী', icon: 'library', color: 'text-yellow-600 bg-yellow-50 dark:bg-yellow-900/20' },
                { id: 9, name: 'এসএসসি', icon: 'microscope', color: 'text-purple-600 bg-purple-50 dark:bg-purple-900/20' },
                { id: 11, name: 'এইচএসসি', icon: 'atom', color: 'text-indigo-600 bg-indigo-50 dark:bg-indigo-900/20' }
            ];
            classes.forEach(c => {
                const el = document.createElement('div');
                el.className = `w-40 md:w-56 h-36 md:h-48 bg-white dark:bg-gray-900 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-800 flex flex-col items-center justify-center cursor-pointer card-hover p-4`;
                el.onclick = () => selectClass(c.id, c.name);
                el.innerHTML = `<div class="h-12 w-12 md:h-16 md:w-16 rounded-full ${c.color} flex items-center justify-center mb-3"><i data-lucide="${c.icon}" class="h-6 w-6 md:h-8 md:w-8"></i></div><h3 class="font-bold text-gray-800 dark:text-white text-lg">${c.name}</h3>`;
                if(c.id <= 8) rowJun.appendChild(el); else rowSen.appendChild(el);
            });
        }

        function updateGroup() { currentGroup = document.getElementById('group-select').value; renderSubjects(); }
        function toggleOptionalSubjects() { showOptional = document.getElementById('toggle-optional').checked; renderSubjects(); }

        function renderSubjects() {
            const container = document.getElementById('subject-content'); container.innerHTML = '';
            let subs = subjectsData[currentClass.id] || [];
            
            if (currentClass.id === 9 || currentClass.id === 11) {
                const groupSubs = subs.filter(s => s.group === currentGroup && (isEditMode || showOptional || !s.isOptional));
                const commonSubs = subs.filter(s => s.group === 'common' && (isEditMode || showOptional || !s.isOptional));
                renderSubjectSection(container, 'বিভাগের বিষয়', groupSubs);
                renderSubjectSection(container, 'আবশ্যিক ও অন্যান্য', commonSubs);
            } else {
                const visibleSubs = subs.filter(s => isEditMode || showOptional || !s.isOptional);
                renderSubjectSection(container, '', visibleSubs);
            }
            updateBulkActionBar('subjects'); lucide.createIcons();
        }

        function renderSubjectSection(container, title, items) {
            if(items.length===0) return;
            
            if(title) {
                const h3 = document.createElement('h3');
                h3.className = "text-lg font-bold text-gray-500 mb-3 mt-6 px-1";
                h3.innerText = title;
                container.appendChild(h3);
            }

            const grid = document.createElement('div'); grid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4';
            items.forEach(sub => {
                const isSelected = selectedIds.has(sub.id);
                const el = document.createElement('div');
                const isHidden = sub.isOptional && !showOptional && isEditMode;
                
                // Apply specific style for group optional subjects
                let extraClass = '';
                if (sub.isGroupOptional) {
                    extraClass = 'group-optional border-dashed border-2';
                }
                
                el.className = `bg-white dark:bg-gray-900 p-4 rounded-xl border ${isSelected?'border-indigo-500 ring-2 ring-indigo-500/20':'border-gray-100 dark:border-gray-800'} hover:shadow-md cursor-pointer transition relative group select-none ${isHidden ? 'is-hidden-subject' : ''} ${extraClass}`;
                
                // FIX: Use manual event listener instead of HTML onclick for complex drag logic inside loop
                // This ensures closure context is correct
                if(isEditMode) {
                    el.draggable = true;
                    el.addEventListener('click', (e) => { 
                        if (e.target.closest('button')) return; 
                        toggleSelection(sub.id); 
                        renderSubjects(); 
                    });
                    
                    el.addEventListener('dragstart', (e) => { 
                        dragSrcId = sub.id; 
                        e.target.classList.add('dragging'); 
                    });
                    
                    el.addEventListener('dragend', (e) => { 
                        e.target.classList.remove('dragging'); 
                    });
                    
                    el.addEventListener('dragover', (e) => { e.preventDefault(); });
                    
                    el.addEventListener('drop', (e) => handleSubjectDrop(e, sub.id));
                } else {
                    el.addEventListener('click', () => openReader(sub));
                }

                let controls = isEditMode ? `<div class="absolute top-2 right-2 btn-visible-anim"><button onclick="event.stopPropagation(); editSubject('${sub.id}')" class="p-1 bg-blue-50 text-blue-600 rounded-full"><i data-lucide="pencil" class="h-3 w-3"></i></button></div>` : '';

                el.innerHTML = `${controls}
                    <div class="flex items-center gap-3">
                        <div class="p-2.5 rounded-lg bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400"><i data-lucide="${sub.icon}" class="h-5 w-5"></i></div>
                        <div><h4 class="font-bold text-gray-800 dark:text-white text-base">${sub.name}</h4><p class="text-xs text-gray-500">${sub.desc}</p></div>
                    </div>`;
                grid.appendChild(el);
            });
            container.appendChild(grid);
        }

        // --- GLOBAL FUNCTIONS: BULK ACTIONS ---
        // Moved to top level to ensure visibility
        function bulkToggleVisibilitySubjects() {
            if (!currentClass || !subjectsData[currentClass.id]) return;
            subjectsData[currentClass.id].forEach(s => {
                if(selectedIds.has(s.id)) s.isOptional = !s.isOptional;
            });
            selectedIds.clear();
            saveData();
            renderSubjects();
        }

        function bulkDeleteSubjects() {
             openConfirmModal(`${selectedIds.size} টি বিষয় মুছতে চান?`, () => {
                 subjectsData[currentClass.id] = subjectsData[currentClass.id].filter(s => !selectedIds.has(s.id));
                 selectedIds.clear(); saveData(); renderSubjects();
             });
        }

        function bulkDeleteChapters() {
             openConfirmModal(`${selectedIds.size} টি অধ্যায় মুছতে চান?`, () => {
                 function filter(list) { return list.filter(n => { if(selectedIds.has(n.id)) return false; if(n.children) n.children=filter(n.children); return true; }); }
                 currentSubject.chapters = filter(currentSubject.chapters); selectedIds.clear(); saveData(); renderChapters();
             });
        }

        // --- SUBJECT DRAG & DROP LOGIC ---
        function handleSubjectDrop(e, targetId) {
            e.stopPropagation();
            if(dragSrcId === targetId) return;
            const list = subjectsData[currentClass.id];
            const srcIdx = list.findIndex(s => s.id === dragSrcId);
            const tgtIdx = list.findIndex(s => s.id === targetId);
            
            if(srcIdx > -1 && tgtIdx > -1) {
                const [moved] = list.splice(srcIdx, 1);
                list.splice(tgtIdx, 0, moved);
                saveData(); renderSubjects();
            }
        }

        // --- READER VIEW LOGIC ---
        function openReader(sub) {
            currentSubject = sub;
            if(currentSubject.chapters) currentSubject.chapters.forEach(ensureContentStructure);
            hideAllViews();
            document.getElementById('view-reader').classList.remove('hidden');
            document.getElementById('reader-subject-title').innerText = `${currentClass.name} > ${sub.name}`;
            document.getElementById('content-empty').classList.remove('hidden');
            document.getElementById('content-tabs').classList.add('hidden');
            ['text', 'pdf', 'video', 'qna'].forEach(t => document.getElementById(`tab-content-${t}`).classList.add('hidden'));
            selectedIds.clear();
            renderChapters();
        }

        function renderChapters() {
            const list = document.getElementById('chapter-list'); list.innerHTML = '';
            if(!currentSubject.chapters || currentSubject.chapters.length===0) document.getElementById('empty-chapters-msg').classList.remove('hidden');
            else {
                document.getElementById('empty-chapters-msg').classList.add('hidden');
                currentSubject.chapters.forEach(node => list.appendChild(createChapterNode(node, 0)));
            }
            updateBulkActionBar('chapters'); lucide.createIcons();
        }

        function createChapterNode(node, depth) {
            const div = document.createElement('div');
            const hasChildren = node.children && node.children.length > 0;
            const isOpen = openAccordionIds.has(node.id);
            const isSelected = selectedIds.has(node.id);
            const isActive = currentChapterNode && currentChapterNode.id === node.id;
            const padding = 0.5 + (depth * 1.2);

            let checkbox = isEditMode ? `<input type="checkbox" ${isSelected?'checked':''} class="mr-2 accent-indigo-600 h-4 w-4" onclick="toggleSelection('${node.id}'); renderChapters(); event.stopPropagation();">` : '';
            
            div.innerHTML = `
            <div class="group flex items-center justify-between p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 cursor-pointer mb-1 select-none ${isActive ? 'bg-indigo-100 dark:bg-indigo-900/40 text-indigo-700 dark:text-indigo-300' : ''}" 
                 style="padding-left: ${padding}rem" onclick="clickChapter('${node.id}', event)">
                <div class="flex items-center gap-2 overflow-hidden w-full">
                    ${checkbox}
                    <i id="icon-${node.id}" data-lucide="${hasChildren ? 'chevron-right' : 'circle'}" class="h-4 w-4 text-gray-400 transition-transform ${hasChildren && isOpen ? 'rotate-90' : ''} ${!hasChildren ? 'h-1.5 w-1.5 mt-0.5 ml-1' : ''}"></i>
                    <span class="truncate text-sm font-medium ${isActive ? 'font-bold' : ''}">${node.title}</span>
                </div>
            </div>
            <div id="acc-${node.id}" class="accordion-content ${isOpen ? 'open' : ''}"></div>`;

            if(isEditMode) {
                div.firstElementChild.draggable = true;
                div.firstElementChild.ondragstart = (e) => { dragSrcId = node.id; e.stopPropagation(); e.target.style.opacity = '0.5'; };
                div.firstElementChild.ondragend = (e) => { e.target.style.opacity = '1'; removeDragClasses(); };
                div.firstElementChild.ondragover = handleChapDragOver;
                div.firstElementChild.ondragleave = handleChapDragLeave;
                div.firstElementChild.ondrop = (e) => handleChapDrop(e, node.id);
            }

            const container = div.querySelector('.accordion-content');
            if(node.children) node.children.forEach(c => container.appendChild(createChapterNode(c, depth + 1)));
            return div;
        }

        function findNode(nodes, id) {
            for(let n of nodes) { if(n.id===id) return n; if(n.children) { const f = findNode(n.children, id); if(f) return f; } } return null;
        }
        function findParent(nodes, id) {
             for(let i=0; i<nodes.length; i++) {
                 if(nodes[i].id === id) return { p: nodes, i };
                 if(nodes[i].children) { const f = findParent(nodes[i].children, id); if(f) return f; }
             }
             return null;
        }

        function clickChapter(id, e) {
            if(isEditMode && e && e.target && e.target.tagName === 'INPUT') return;
            const node = findNode(currentSubject.chapters, id);
            
            if(node.children && node.children.length > 0) {
                const el = document.getElementById(`acc-${id}`);
                if(el.classList.contains('open')) { el.classList.remove('open'); openAccordionIds.delete(id); }
                else { el.classList.add('open'); openAccordionIds.add(id); }
                renderChapters(); 
            }

            currentChapterNode = node;
            document.getElementById('chapter-title').innerText = node.title;
            document.getElementById('content-empty').classList.add('hidden');
            document.getElementById('content-tabs').classList.remove('hidden');
            renderChapters(); 
            switchTab(activeTab); 
        }

        // --- DRAG & DROP LOGIC ---
        function handleChapDragOver(e) {
            e.preventDefault(); e.stopPropagation();
            const rect = e.currentTarget.getBoundingClientRect();
            const y = e.clientY - rect.top;
            removeDragClasses(e.currentTarget);
            const id = e.currentTarget.parentNode.querySelector('.accordion-content').id.replace('acc-', '');
            if(y > rect.height * 0.25 && y < rect.height * 0.75) {
                 e.currentTarget.classList.add('drag-over-middle');
                 if(!expandTimer) expandTimer = setTimeout(() => { if(document.querySelector('.drag-over-middle')) clickChapter(id); }, 800);
            } else if (y < rect.height * 0.25) e.currentTarget.classList.add('drag-over-top');
            else e.currentTarget.classList.add('drag-over-bottom');
        }
        function handleChapDragLeave(e) { removeDragClasses(e.currentTarget); clearTimeout(expandTimer); expandTimer = null; }
        function removeDragClasses(el) { if(el) el.classList.remove('drag-over-top', 'drag-over-bottom', 'drag-over-middle'); else document.querySelectorAll('.drag-over-top, .drag-over-bottom, .drag-over-middle').forEach(x => removeDragClasses(x)); }
        
        function handleChapDrop(e, targetId) {
            e.stopPropagation(); clearTimeout(expandTimer); removeDragClasses();
            if(dragSrcId === targetId) return;
            const srcNode = findNode(currentSubject.chapters, dragSrcId);
            if(isDescendant(srcNode, targetId)) { alert("Parent cannot be moved inside child."); return; }
            
            const srcInfo = findParent(currentSubject.chapters, dragSrcId);
            if(!srcInfo) return;
            const movedItem = srcInfo.p.splice(srcInfo.i, 1)[0];
            
            const rect = e.currentTarget.getBoundingClientRect();
            const y = e.clientY - rect.top;

            if (y > rect.height * 0.25 && y < rect.height * 0.75) {
                const tgtNode = findNode(currentSubject.chapters, targetId);
                if(!tgtNode.children) tgtNode.children = [];
                tgtNode.children.push(movedItem);
                openAccordionIds.add(targetId);
            } else {
                const tgtInfo = findParent(currentSubject.chapters, targetId);
                const pos = (y > rect.height * 0.75) ? tgtInfo.i + 1 : tgtInfo.i;
                tgtInfo.p.splice(pos, 0, movedItem);
            }
            saveData(); renderChapters();
        }
        function isDescendant(parent, childId) {
            if(!parent.children) return false;
            for(let c of parent.children) { if(c.id === childId) return true; if(isDescendant(c, childId)) return true; }
            return false;
        }

        // --- CONTENT TABS & RENDERING ---
        function switchTab(tab) {
            activeTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
            document.getElementById(`tab-btn-${tab}`).classList.add('tab-active');
            ['text', 'pdf', 'video', 'qna'].forEach(t => document.getElementById(`tab-content-${t}`).classList.add('hidden'));
            document.getElementById(`tab-content-${tab}`).classList.remove('hidden');
            renderActiveTabContent();
        }

        function renderActiveTabContent() {
            if (!currentChapterNode) return;
            const content = currentChapterNode.content;

            if (activeTab === 'text') {
                const viewer = document.getElementById('render-markdown');
                const emptyMsg = document.getElementById('empty-text-msg');
                const loader = document.getElementById('loading-indicator');
                
                viewer.innerHTML = '';
                emptyMsg.classList.add('hidden');
                
                // Prioritize fetching URL if exists
                if (content.textUrl) {
                    loader.classList.remove('hidden');
                    fetchTextContent(content.textUrl)
                        .then(text => {
                            viewer.innerHTML = marked.parse(text);
                            loader.classList.add('hidden');
                        })
                        .catch(err => {
                            viewer.innerHTML = `<div class="text-red-500 text-center">Error loading content: ${err.message}<br><a href="${content.textUrl}" target="_blank" class="underline">Open Link</a></div>`;
                            loader.classList.add('hidden');
                        });
                } else if (content.text && content.text.trim()) {
                    viewer.innerHTML = marked.parse(content.text);
                } else {
                    emptyMsg.classList.remove('hidden');
                }
            } else if (activeTab === 'pdf') {
                const frame = document.getElementById('pdf-frame');
                if (content.pdfUrl) {
                    frame.src = content.pdfUrl;
                    frame.classList.remove('hidden');
                    document.getElementById('empty-pdf-msg').classList.add('hidden');
                } else {
                    frame.classList.add('hidden');
                    document.getElementById('empty-pdf-msg').classList.remove('hidden');
                }
            } else if (activeTab === 'video') {
                const grid = document.getElementById('video-grid');
                grid.innerHTML = '';
                if (content.videos && content.videos.length > 0) {
                    content.videos.forEach((v, index) => {
                        let innerHTML = '';
                        
                        // Determine content type
                        if (v.id) { // YouTube
                             innerHTML = `<iframe id="yt-player-${index}" class="w-full h-full" 
                                src="https://www.youtube.com/embed/${v.id}?enablejsapi=1&rel=0&modestbranding=1" 
                                frameborder="0" allowfullscreen></iframe>`;
                             
                             // Attach API Logic safely
                             setTimeout(() => {
                                 if (window.YT && window.YT.Player) {
                                     new YT.Player(`yt-player-${index}`, {
                                         events: {
                                             'onStateChange': (event) => {
                                                 if (event.data == YT.PlayerState.PAUSED || event.data == YT.PlayerState.ENDED) {
                                                     v.currentTime = event.target.getCurrentTime();
                                                 }
                                             }
                                         }
                                     });
                                 }
                             }, 1000);
                        } else if (v.url && (v.url.endsWith('.mp4') || v.url.endsWith('.webm') || v.url.startsWith('blob:'))) { 
                            // Native Video
                            innerHTML = `<video id="vid-${index}" class="w-full h-full object-contain" src="${v.url}" controls></video>`;
                        } else { 
                            innerHTML = `
                            <div class="flex flex-col items-center justify-center h-full p-4 text-center bg-gray-100 dark:bg-gray-800 text-gray-500">
                                <i data-lucide="external-link" class="h-8 w-8 mb-2 opacity-50"></i>
                                <a href="${v.url}" target="_blank" class="text-indigo-600 underline font-bold text-sm">ভিডিও লিংক খুলুন</a>
                            </div>`;
                        }

                        // Apply stored resize dimensions if available
                        const style = (v.width && v.height) ? `width: ${v.width}px; height: ${v.height}px; flex: none;` : '';

                        // Render Card
                        const card = document.createElement('div');
                        card.className = `bg-black dark:bg-black rounded-lg overflow-hidden shadow-sm resizable-card relative group border border-gray-200 dark:border-gray-700`;
                        card.style = style;
                        card.innerHTML = `
                            <div class="flex-grow relative overflow-hidden bg-black flex items-center justify-center">
                                ${innerHTML}
                            </div>
                            <div class="p-3 h-12 bg-white dark:bg-gray-900 flex items-center justify-between flex-none border-t border-gray-100 dark:border-gray-800">
                                <h4 class="font-bold text-sm dark:text-white truncate w-3/4" title="${v.title}">${v.title}</h4>
                                <div class="cursor-se-resize p-1"><i data-lucide="maximize-2" class="h-3 w-3 text-gray-400"></i></div>
                            </div>
                        `;
                        
                        grid.appendChild(card);

                        // 1. Time Persistence for Local Videos
                        const vidEl = card.querySelector('video');
                        if (vidEl) {
                            if (v.currentTime) {
                                vidEl.currentTime = v.currentTime;
                            }
                            vidEl.addEventListener('timeupdate', () => {
                                v.currentTime = vidEl.currentTime;
                            });
                        }

                        // 2. Size Persistence (ResizeObserver)
                        const resizeObserver = new ResizeObserver(entries => {
                            for (let entry of entries) {
                                const { width, height } = entry.contentRect;
                                v.width = width;
                                v.height = height;
                                debouncedSave(); // Auto-save size changes
                            }
                        });
                        resizeObserver.observe(card);
                    });
                    document.getElementById('empty-video-msg').classList.add('hidden');
                } else {
                    document.getElementById('empty-video-msg').classList.remove('hidden');
                }
            } else if (activeTab === 'qna') {
                const list = document.getElementById('qna-list');
                list.innerHTML = '';
                if (content.qna && content.qna.length > 0) {
                    content.qna.forEach((qa, idx) => {
                        list.innerHTML += `
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                            <div class="bg-gray-100 dark:bg-gray-800 p-3 font-bold text-gray-800 dark:text-gray-200 text-sm cursor-pointer" onclick="this.nextElementSibling.classList.toggle('hidden')">
                                <span class="text-indigo-600 mr-2">Q${idx+1}.</span> ${qa.q}
                            </div>
                            <div class="p-4 bg-white dark:bg-gray-900/50 text-gray-700 dark:text-gray-300 hidden border-t border-gray-100 dark:border-gray-800 prose dark:prose-invert max-w-none text-sm">
                                ${marked.parse(qa.a)}
                            </div>
                        </div>`;
                    });
                    document.getElementById('empty-qna-msg').classList.add('hidden');
                } else {
                    document.getElementById('empty-qna-msg').classList.remove('hidden');
                }
            }
            lucide.createIcons();
        }

        // --- LOCAL FILE HANDLERS (SESSION ONLY) ---
        function loadLocalTextFile(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentChapterNode.content.text = e.target.result; 
                    currentChapterNode.content.textUrl = ''; // clear url if local file loaded
                    renderActiveTabContent(); 
                };
                reader.readAsText(input.files[0]);
            }
        }

        function loadLocalPdfFile(input) {
            if (input.files && input.files[0]) {
                const url = URL.createObjectURL(input.files[0]);
                const frame = document.getElementById('pdf-frame');
                frame.src = url;
                frame.classList.remove('hidden');
                document.getElementById('empty-pdf-msg').classList.add('hidden');
            }
        }

        function loadLocalVideoFile(input) {
            if (input.files && input.files[0]) {
                const url = URL.createObjectURL(input.files[0]);
                const title = input.files[0].name;
                if(!currentChapterNode.content.videos) currentChapterNode.content.videos = [];
                currentChapterNode.content.videos.push({ title: title, url: url });
                renderActiveTabContent();
            }
        }

        // --- CLOUD TEXT FETCHING LOGIC (ROBUST) ---
        function openAddTextLinkModal() {
            document.getElementById('input-text-url').value = currentChapterNode.content.textUrl || '';
            openModal('modal-add-text-link');
        }

        function saveTextLink() {
            const url = document.getElementById('input-text-url').value.trim();
            if (url) {
                currentChapterNode.content.textUrl = url;
                saveData();
                renderActiveTabContent();
                closeModal('modal-add-text-link');
            }
        }

        async function fetchTextContent(url) {
            // Basic validation
            if (!url || !url.startsWith('http')) {
                throw new Error("Invalid URL. Please include http:// or https://");
            }

            let targetUrl = url;
            
            // 1. Google Drive Handling - Robust ID extraction
            if (url.includes('drive.google.com')) {
                let fileId = null;
                // Match /d/ID or id=ID
                const idMatch = url.match(/\/d\/([a-zA-Z0-9_-]+)/) || url.match(/id=([a-zA-Z0-9_-]+)/);
                
                if (idMatch && idMatch[1]) {
                    fileId = idMatch[1];
                    // 'uc' endpoint is for download/raw view
                    targetUrl = `https://drive.google.com/uc?id=${fileId}&export=download`;
                }
            }

            // List of proxies to try
            const proxies = [
                (u) => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
                (u) => `https://corsproxy.io/?${encodeURIComponent(u)}` // Backup
            ];

            let lastError;

            for (const createProxyUrl of proxies) {
                try {
                    const fetchUrl = createProxyUrl(targetUrl);
                    const response = await fetch(fetchUrl);
                    if (!response.ok) {
                        // If 404/500, throw to try next proxy
                        throw new Error(`Status ${response.status}`);
                    }
                    return await response.text();
                } catch (error) {
                    console.warn(`Proxy failed:`, error);
                    lastError = error;
                    // Continue to next proxy
                }
            }

            // If all failed
            throw new Error(`Unable to load content. Valid URL? CORS issue? (${lastError?.message || 'Unknown error'})`);
        }

        // --- EDIT CONTENT MODALS ---
        function openEditContentModal(type) {
            if(!currentChapterNode) return;
            const content = currentChapterNode.content;
            if (type === 'text') {
                document.getElementById('input-content-text').value = content.text || '';
                document.getElementById('preview-content-text').innerHTML = marked.parse(content.text || '');
                openModal('modal-edit-text');
            } else if (type === 'pdf') {
                document.getElementById('input-content-pdf').value = content.pdfUrl || '';
                openModal('modal-edit-pdf');
            } else if (type === 'video') {
                document.getElementById('input-video-title').value = '';
                document.getElementById('input-video-url').value = '';
                renderManageVideoList();
                openModal('modal-edit-video');
            } else if (type === 'qna') {
                document.getElementById('input-qna-q').value = '';
                document.getElementById('input-qna-a').value = '';
                renderManageQnaList();
                openModal('modal-edit-qna');
            }
        }

        function saveContentText() {
            currentChapterNode.content.text = document.getElementById('input-content-text').value;
            // Clear URL if manual text is saved to avoid conflict/confusion
            if(document.getElementById('input-content-text').value.trim()) {
                 // Optional: decide if text overrides URL or vice versa. 
                 // Here we keep both but renderer prioritizes URL if present.
            }
            saveData(); renderActiveTabContent(); closeModal('modal-edit-text');
        }

        function saveContentPdf() {
            let url = document.getElementById('input-content-pdf').value.trim();
            if(url.includes('drive.google.com') && url.includes('/view')) { url = url.replace('/view', '/preview'); }
            currentChapterNode.content.pdfUrl = url;
            saveData(); renderActiveTabContent(); closeModal('modal-edit-pdf');
        }

        function addVideo() {
            const title = document.getElementById('input-video-title').value;
            const inputVal = document.getElementById('input-video-url').value.trim();
            
            let url = inputVal;
            let vidId = null;

            // 1. Check for Iframe Embed Code
            if (inputVal.startsWith('<iframe')) {
                // Extract src using regex
                const srcMatch = inputVal.match(/src="([^"]+)"/);
                if (srcMatch && srcMatch[1]) {
                    url = srcMatch[1];
                }
            }

            // 2. Check for YouTube ID (if it's a direct link or extracted src)
            const ytMatch = url.match(/(?:youtu\.be\/|youtube\.com\/(?:.*v=|.*\/))([^"&?\/\s]{11})/);
            if (ytMatch) vidId = ytMatch[1];

            if(title && (vidId || url)) {
                if(!currentChapterNode.content.videos) currentChapterNode.content.videos = [];
                currentChapterNode.content.videos.push({ title, url, id: vidId }); 
                saveData(); renderManageVideoList(); renderActiveTabContent();
                document.getElementById('input-video-title').value = ''; document.getElementById('input-video-url').value = '';
            } else { alert("সঠিক ভিডিও লিংক বা এমবেড কোড দিন"); }
        }

        function deleteVideo(idx) {
            currentChapterNode.content.videos.splice(idx, 1);
            saveData(); renderManageVideoList(); renderActiveTabContent();
        }
        function renderManageVideoList() {
            const list = document.getElementById('video-list-manage');
            list.innerHTML = '';
            (currentChapterNode.content.videos || []).forEach((v, i) => {
                list.innerHTML += `<div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-800 mb-1 rounded"><span class="text-xs truncate dark:text-white w-3/4">${v.title}</span><button onclick="deleteVideo(${i})" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="h-4 w-4"></i></button></div>`;
            });
            lucide.createIcons();
        }

        function addQna() {
            const q = document.getElementById('input-qna-q').value; const a = document.getElementById('input-qna-a').value;
            if(q && a) {
                if(!currentChapterNode.content.qna) currentChapterNode.content.qna = [];
                currentChapterNode.content.qna.push({ q, a });
                saveData(); renderManageQnaList(); renderActiveTabContent();
                document.getElementById('input-qna-q').value = ''; document.getElementById('input-qna-a').value = '';
            }
        }
        function deleteQna(idx) {
            currentChapterNode.content.qna.splice(idx, 1);
            saveData(); renderManageQnaList(); renderActiveTabContent();
        }
        function renderManageQnaList() {
             const list = document.getElementById('qna-list-manage'); list.innerHTML = '';
            (currentChapterNode.content.qna || []).forEach((qa, i) => {
                list.innerHTML += `<div class="flex justify-between items-start p-2 bg-gray-50 dark:bg-gray-800 mb-1 rounded"><div class="w-3/4"><p class="text-xs font-bold dark:text-white truncate">${qa.q}</p><p class="text-xs text-gray-500 truncate">${qa.a}</p></div><button onclick="deleteQna(${i})" class="text-red-500 hover:text-red-700 mt-1"><i data-lucide="trash-2" class="h-4 w-4"></i></button></div>`;
            });
            lucide.createIcons();
        }

        // --- GLOBAL FUNCTIONS: BULK ACTIONS ---
        function bulkToggleVisibilitySubjects() {
            if (!currentClass || !subjectsData[currentClass.id]) return;
            subjectsData[currentClass.id].forEach(s => {
                if(selectedIds.has(s.id)) s.isOptional = !s.isOptional;
            });
            selectedIds.clear();
            saveData();
            renderSubjects();
        }

        function bulkDeleteSubjects() {
             openConfirmModal(`${selectedIds.size} টি বিষয় মুছতে চান?`, () => {
                 subjectsData[currentClass.id] = subjectsData[currentClass.id].filter(s => !selectedIds.has(s.id));
                 selectedIds.clear(); saveData(); renderSubjects();
             });
        }

        function bulkDeleteChapters() {
             openConfirmModal(`${selectedIds.size} টি অধ্যায় মুছতে চান?`, () => {
                 function filter(list) { return list.filter(n => { if(selectedIds.has(n.id)) return false; if(n.children) n.children=filter(n.children); return true; }); }
                 currentSubject.chapters = filter(currentSubject.chapters); selectedIds.clear(); saveData(); renderChapters();
             });
        }

        // --- UTILS & SHARED ---
        function toggleTheme() { 
            document.documentElement.classList.toggle('dark'); 
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); 
            lucide.createIcons(); 
        }
        
        function checkTheme() { 
            if(localStorage.getItem('theme')==='dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        function toggleEditMode() {
            isEditMode = !isEditMode; selectedIds.clear(); updateEditModeUI();
            const isReader = !document.getElementById('view-reader').classList.contains('hidden');
            if(isReader) renderChapters(); else renderSubjects();
        }
        function updateEditModeUI() {
            const btns = document.querySelectorAll('#btn-edit-mode, #btn-edit-mode-reader');
            btns.forEach(btn => {
                if(isEditMode) {
                    btn.innerHTML = '<i data-lucide="check" class="h-4 w-4"></i> শেষ করুন';
                    btn.className = "flex items-center gap-2 bg-red-100 text-red-600 px-3 py-2 rounded-lg text-sm font-medium transition";
                } else {
                    btn.innerHTML = '<i data-lucide="edit-3" class="h-4 w-4"></i> এডিট';
                    btn.className = "bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2";
                }
            });
            updateBulkActionBar(document.getElementById('view-reader').classList.contains('hidden') ? 'subjects' : 'chapters');
            lucide.createIcons();
        }
        function toggleSelection(id) { if (selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id); }
        function clearSelection() { selectedIds.clear(); const isReader = !document.getElementById('view-reader').classList.contains('hidden'); if(isReader) renderChapters(); else renderSubjects(); }
        function updateBulkActionBar(type) {
            const bar = document.getElementById(`bulk-action-bar-${type}`); if(!bar) return;
            const countSpan = document.getElementById(`selected-count-${type === 'subjects' ? 'subs' : 'chaps'}`);
            if (isEditMode && selectedIds.size > 0) { bar.classList.remove('hidden'); countSpan.innerText = selectedIds.size; } else { bar.classList.add('hidden'); }
        }
        function openModal(id) { document.getElementById(id).classList.remove('opacity-0', 'pointer-events-none'); document.body.classList.add('modal-active'); }
        function closeModal(id) { document.getElementById(id).classList.add('opacity-0', 'pointer-events-none'); document.body.classList.remove('modal-active'); }
        let confirmCb = null;
        function openConfirmModal(msg, cb) { document.getElementById('confirm-modal-text').innerText = msg; confirmCb = cb; openModal('modal-confirm'); }
        document.getElementById('confirm-modal-btn').onclick = () => { if(confirmCb) confirmCb(); closeModal('modal-confirm'); };
        function confirmReset() { openConfirmModal("সতর্কতা: সব ডাটা মুছে যাবে। আপনি কি নিশ্চিত?", resetData); }
        
        // ... (Remaining Bulk Import/Export logic kept same) ...
        // Re-injecting bulk import logic for completeness
        function openBulkImportSubjectModal(isChapter = false) { 
            const title = isChapter ? "বাল্ক ইম্পোর্ট (অধ্যায়)" : "বাল্ক ইম্পোর্ট (বিষয়)";
            document.getElementById('modal-bulk-title').innerText = title;
            document.getElementById('bulk-import-text').value='';
            const btn = document.getElementById('btn-bulk-process');
            btn.onclick = isChapter ? processBulkImportChapter : processBulkImport;
            btn.innerText = "ইম্পোর্ট করুন";
            document.getElementById('bulk-import-controls').classList.remove('hidden');
            openModal('modal-bulk-import'); 
        }
        function processBulkImport() {
    const txt = document.getElementById('bulk-import-text').value; 
    const includeCh = document.getElementById('bulk-include-chapters').checked;
    const lines = txt.split('\n').filter(l => l.trim());
    
    let activeSubjects = []; // Holds references to currently created subjects to add chapters to
    let stack = []; // For chapter nesting - NOTE: With multiple subjects, we assume identical structure

    const isJunior = [6, 7, 8].includes(parseInt(currentClass.id));

    lines.forEach(line => {
        const trimmed = line.trim();
        
        // 1. Check for Subject Definitions
        if (trimmed.startsWith('*') || (trimmed.startsWith('!') && !isJunior)) {
            activeSubjects = []; // Reset active subjects
            
            // Case: Common Subjects (* or **)
            if (trimmed.startsWith('*')) {
                const isDouble = trimmed.startsWith('**');
                const name = isDouble ? trimmed.substring(2).trim() : trimmed.substring(1).trim();
                
                if (name) {
                    const sub = {
                        id: `sub_${currentClass.id}_${Date.now()}_${Math.random().toString(36).substr(2,5)}`,
                        name: name,
                        desc: isDouble ? 'অপ্রয়োজনীয় (ঐচ্ছিক)' : 'আবশ্যিক',
                        icon: 'book',
                        group: 'common',
                        isOptional: isDouble, // ** means hidden by default
                        isGroupOptional: false,
                        chapters: []
                    };
                    subjectsData[currentClass.id].push(sub);
                    activeSubjects.push(sub);
                }
            }
            // Case: Group Subjects (!1, !1*, !12*, etc) - Only for Senior
            else if (trimmed.startsWith('!') && !isJunior) {
                // Regex to parse: ! followed by digits, optional *, then name
                const match = trimmed.match(/^!([123]+)(\*)?\s*(.*)/);
                if (match) {
                    const groupsStr = match[1]; // e.g. "12"
                    const isGroupOpt = !!match[2]; // true if * exists
                    const name = match[3];
                    
                    const groupMap = { '1': 'science', '2': 'arts', '3': 'commerce' };
                    
                    // Iterate over each digit (1, 2, 3)
                    for (const char of groupsStr) {
                        const grp = groupMap[char];
                        if (grp && name) {
                            const sub = {
                                id: `sub_${currentClass.id}_${Date.now()}_${Math.random().toString(36).substr(2,5)}`,
                                name: name,
                                desc: isGroupOpt ? 'বিভাগীয় ঐচ্ছিক' : 'বিভাগীয়',
                                icon: 'book',
                                group: grp,
                                isOptional: false, // Visible by default
                                isGroupOptional: isGroupOpt, // Tag for styling
                                chapters: []
                            };
                            subjectsData[currentClass.id].push(sub);
                            activeSubjects.push(sub);
                        }
                    }
                }
            }
        }
        // 2. Check for Chapter Definitions
        else if (activeSubjects.length > 0 && includeCh && (trimmed.startsWith('#') || trimmed.startsWith('-'))) {
             let depth = -1;
             let title = '';
             if (trimmed.startsWith('#')) { depth = 0; title = trimmed.substring(1).trim(); }
             else if (trimmed.startsWith('-')) {
                 const match = trimmed.match(/^(-+)\s*(.*)/);
                 if (match) { depth = match[1].length; title = match[2].trim(); }
             }

             if (depth > -1 && title) {
                 // Add chapter to ALL currently active subjects
                 activeSubjects.forEach((sub) => {
                     // We need a unique ID for each instance to allow independent tracking/editing later
                     const newNode = { 
                         id: `ch_${Date.now()}_${Math.random().toString(36).substr(2,5)}`, 
                         title: title, 
                         children: [],
                         content: { text: '', pdfUrl: '', videos: [], qna: [], textUrl: '' }
                     };
                     
                     // We need separate stack tracking for each subject to handle multi-subject imports correctly
                     if (!sub._importStack) sub._importStack = [];
                     const stack = sub._importStack;
                     
                     if (stack.length === 0) {
                         sub.chapters.push(newNode);
                         stack.push({ node: newNode, depth: depth });
                     } else {
                         while (stack.length > 0 && stack[stack.length - 1].depth >= depth) stack.pop();
                         if (stack.length > 0) stack[stack.length - 1].node.children.push(newNode);
                         else sub.chapters.push(newNode);
                         stack.push({ node: newNode, depth: depth });
                     }
                 });
             }
        }
    });
    
    // Cleanup temporary stacks
    if(subjectsData[currentClass.id]) {
        subjectsData[currentClass.id].forEach(s => delete s._importStack);
    }
    
    saveData(); renderSubjects(); closeModal('modal-bulk-import');
}
        function processBulkImportChapter() {
             const txt = document.getElementById('bulk-import-text').value; 
             const lines = txt.split('\n').filter(l=>l.trim());
             let stack = [];
             lines.forEach(line => {
                 const t = line.trim();
                 let depth = -1; let title = '';
                 if(t.startsWith('#')) { depth=0; title=t.substring(1).trim(); }
                 else if (t.startsWith('-')) {
                     const match = t.match(/^(-+)\s*(.*)/);
                     if(match) { depth = match[1].length; title = match[2].trim(); }
                 }
                 if(depth>-1 && title) {
                     const newNode = { id:`ch_${Date.now()}_${Math.random()}`, title: title, children:[], content: {text:'',pdfUrl:'',videos:[],qna:[]} };
                     if(stack.length===0) {
                         currentSubject.chapters.push(newNode); stack.push({node:newNode, depth:depth});
                     } else {
                         while(stack.length>0 && stack[stack.length-1].depth >= depth) stack.pop();
                         if(stack.length>0) stack[stack.length-1].node.children.push(newNode);
                         else currentSubject.chapters.push(newNode);
                         stack.push({node:newNode, depth:depth});
                     }
                 }
             });
             saveData(); renderChapters(); closeModal('modal-bulk-import');
        }
        function exportClassData() {
            let output = "";
            const subs = subjectsData[currentClass.id] || [];
            function printNode(node, depth) {
                let prefix = "";
                if(depth === 0) prefix = "#";
                else { for(let i=0; i<depth; i++) prefix += "-"; }
                output += `${prefix} ${node.title}\n`;
                if(node.children) node.children.forEach(c => printNode(c, depth + 1));
            }
            subs.forEach(sub => {
                output += `${sub.isOptional ? '**' : '*'}${sub.name}\n`;
                if(sub.chapters) sub.chapters.forEach(ch => printNode(ch, 0));
                output += "\n";
            });
            document.getElementById('modal-bulk-title').innerText = "বাল্ক এক্সপোর্ট (লিস্ট)";
            document.getElementById('bulk-import-text').value = output;
            document.getElementById('bulk-import-controls').classList.add('hidden');
            const btn = document.getElementById('btn-bulk-process');
            btn.innerText = "কপি করুন";
            btn.onclick = () => { document.getElementById('bulk-import-text').select(); document.execCommand('copy'); alert("কপি হয়েছে!"); };
            openModal('modal-bulk-import');
        }
        function exportChapterData() {
            let output = "";
            function printNode(node, depth) {
                let prefix = "";
                if(depth === 0) prefix = "#";
                else { for(let i=0; i<depth; i++) prefix += "-"; }
                output += `${prefix} ${node.title}\n`;
                if(node.children) node.children.forEach(c => printNode(c, depth + 1));
            }
            if(currentSubject.chapters) currentSubject.chapters.forEach(ch => printNode(ch, 0));
            document.getElementById('modal-bulk-title').innerText = "এক্সপোর্ট (লিস্ট)";
            document.getElementById('bulk-import-text').value = output;
            document.getElementById('bulk-import-controls').classList.add('hidden');
            const btn = document.getElementById('btn-bulk-process');
            btn.innerText = "কপি করুন";
            btn.onclick = () => { document.getElementById('bulk-import-text').select(); document.execCommand('copy'); alert("কপি হয়েছে!"); };
            openModal('modal-bulk-import');
        }
        function openAddSubjectModal() {
             document.getElementById('modal-subject-title').innerText = "নতুন বিষয়"; document.getElementById('input-sub-id').value = '';
             document.getElementById('input-sub-name').value = ''; document.getElementById('input-sub-desc').value = '';
             const gw=document.getElementById('modal-group-select-wrapper'); if(currentClass.id===9||currentClass.id===11) gw.classList.remove('hidden'); else gw.classList.add('hidden');
             openModal('modal-subject');
        }
        function saveSubject() {
            const id = document.getElementById('input-sub-id').value; const name = document.getElementById('input-sub-name').value;
            if(!name) return;
            const newData = { name, desc: document.getElementById('input-sub-desc').value, group: document.getElementById('input-sub-group').value, isOptional: document.getElementById('input-sub-optional').checked, icon: 'book' };
            if(id) { const idx=subjectsData[currentClass.id].findIndex(s=>s.id===id); if(idx>-1) subjectsData[currentClass.id][idx]={...subjectsData[currentClass.id][idx],...newData}; }
            else subjectsData[currentClass.id].push({id:`sub_${Date.now()}`, ...newData, chapters: []});
            saveData(); renderSubjects(); closeModal('modal-subject');
        }
        function editSubject(id) {
             const sub = subjectsData[currentClass.id].find(s => s.id === id); if(!sub) return;
             document.getElementById('modal-subject-title').innerText = "এডিট বিষয়"; document.getElementById('input-sub-id').value = sub.id;
             document.getElementById('input-sub-name').value = sub.name; document.getElementById('input-sub-desc').value = sub.desc||'';
             document.getElementById('input-sub-optional').checked = sub.isOptional;
             const gw=document.getElementById('modal-group-select-wrapper'); if(currentClass.id===9||currentClass.id===11) gw.classList.remove('hidden'); else gw.classList.add('hidden');
             openModal('modal-subject');
        }
        function openAddChapterModal() { document.getElementById('input-chap-name').value = ''; openModal('modal-add-chapter'); }
        function saveNewChapter() {
             const name = document.getElementById('input-chap-name').value;
             if(name) {
                 const newCh = {id:`ch_${Date.now()}`, title:name, children:[], content:{text:'',pdfUrl:'',videos:[],qna:[]}};
                 currentSubject.chapters.push(newCh); saveData(); renderChapters(); closeModal('modal-add-chapter');
             }
        }
        function bulkDeleteChapters() {
             openConfirmModal(`${selectedIds.size} টি অধ্যায় মুছতে চান?`, () => {
                 function filter(list) { return list.filter(n => { if(selectedIds.has(n.id)) return false; if(n.children) n.children=filter(n.children); return true; }); }
                 currentSubject.chapters = filter(currentSubject.chapters); selectedIds.clear(); saveData(); renderChapters();
             });
        }
        function bulkDeleteSubjects() {
             openConfirmModal(`${selectedIds.size} টি বিষয় মুছতে চান?`, () => {
                 subjectsData[currentClass.id] = subjectsData[currentClass.id].filter(s => !selectedIds.has(s.id));
                 selectedIds.clear(); saveData(); renderSubjects();
             });
        }
        function exportData() {
            const dataStr = JSON.stringify(subjectsData);
            navigator.clipboard.writeText(dataStr).then(() => alert("ডাটা ক্লিপবোর্ডে কপি হয়েছে!"));
        }

        window.onload = init;
    </script>
</body>
</html>
